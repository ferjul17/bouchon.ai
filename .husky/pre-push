#!/bin/bash

# Run commands in parallel
pnpm run lint &
PID_LINT=$!
pnpm run format --check &
PID_FORMAT=$!
pnpm run build &
PID_BUILD=$!
pnpm --filter @test-ai/backend test:coverage &
PID_TEST=$!

# Wait for all background processes to finish
FAIL=0

wait $PID_LINT
if [ $? -ne 0 ]; then
  echo "Error: pnpm run lint failed."
  FAIL=1
fi

wait $PID_FORMAT
if [ $? -ne 0 ]; then
  echo "Error: pnpm run format --check failed."
  FAIL=1
fi

wait $PID_BUILD
if [ $? -ne 0 ]; then
  echo "Error: pnpm run build failed."
  FAIL=1
fi

wait $PID_TEST
if [ $? -ne 0 ]; then
  echo "Error: pnpm --filter @test-ai/backend test:coverage failed."
  FAIL=1
fi

if [ $FAIL -ne 0 ]; then
  echo "Pre-push hook failed. Aborting push."
  exit 1
else
  echo "Pre-push hook passed. Proceeding with push."
  exit 0
fi